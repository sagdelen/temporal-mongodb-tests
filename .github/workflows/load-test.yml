name: MongoDB Validation Suite

on:
  workflow_dispatch:
    inputs:
      temporal_version:
        description: "Temporal image tag (e.g., 1.30.0-mongo)"
        required: true
      mongodb_version:
        description: "MongoDB version"
        required: true
        default: "7.0"
      run_e2e:
        description: "Run E2E tests (329 tests)"
        type: boolean
        default: true
      run_load:
        description: "Run load tests"
        type: boolean
        default: true
      load_mode:
        description: "Load test mode"
        type: choice
        options:
          - quick
          - standard
          - full
          - nightly
          - weekly
        default: "standard"

env:
  DOCKER_REGISTRY: agdelen
  NAMESPACE: temporal-mongodb
  TEMPORAL_ADDRESS: localhost:7233
  LOAD_TEST_SUMMARY: /tmp/load-test-summary.md

jobs:
  validate:
    name: Validate ${{ github.event.inputs.temporal_version }}
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: ðŸ” Validate image tag exists
        id: validate_tag
        run: |
          IMAGE="agdelen/temporal"
          TAG="${{ github.event.inputs.temporal_version }}"

          echo "Checking if $IMAGE:$TAG exists on Docker Hub..."

          # Query Docker Hub API
          RESPONSE=$(curl -s "https://hub.docker.com/v2/repositories/$IMAGE/tags/$TAG")

          if echo "$RESPONSE" | grep -q '"name"'; then
            echo "âœ… Image tag found: $IMAGE:$TAG"
            echo "tag_valid=true" >> $GITHUB_OUTPUT
            
            echo ""
            echo "ðŸ“‹ Recent tags available:"
            curl -s "https://hub.docker.com/v2/repositories/$IMAGE/tags?page_size=10" | \
              jq -r '.results[].name' | head -10
          else
            echo "âŒ ERROR: Image tag NOT found: $IMAGE:$TAG"
            echo "tag_valid=false" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸ“‹ Available tags:"
            curl -s "https://hub.docker.com/v2/repositories/$IMAGE/tags?page_size=15" | \
              jq -r '.results[].name'
            echo ""
            echo "Please use one of the available tags above."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Setup infrastructure
        id: setup
        env:
          TEMPORAL_IMAGE_TAG: ${{ github.event.inputs.temporal_version }}
          MONGODB_VERSION: ${{ github.event.inputs.mongodb_version }}
        run: |
          echo "Testing agdelen/temporal:${{ github.event.inputs.temporal_version }}"
          echo "MongoDB: ${{ github.event.inputs.mongodb_version }}"
          mise run setup

      - name: Wait for Temporal
        run: |
          echo "Waiting for Temporal server..."
          for i in {1..60}; do
            if nc -z localhost 7233 2>/dev/null; then
              echo "âœ“ Temporal is reachable on port 7233"
              sleep 5
              exit 0
            fi
            echo "Waiting... ($i/60)"
            sleep 2
          done
          echo "âŒ Timeout waiting for Temporal"
          docker logs temporal-mongodb-server 2>&1 | tail -50
          exit 1

      - name: Run E2E Tests
        id: e2e
        if: ${{ github.event.inputs.run_e2e == 'true' }}
        run: |
          echo "Running 329 E2E tests..."
          mise run tests

      - name: Run Load Tests
        id: load
        if: ${{ github.event.inputs.run_load == 'true' }}
        env:
          LOAD_TEST_SUMMARY: ${{ env.LOAD_TEST_SUMMARY }}
          TEMPORAL_IMAGE_TAG: ${{ github.event.inputs.temporal_version }}
        run: |
          echo "Running load tests (mode: ${{ github.event.inputs.load_mode }})..."
          mise run load:${{ github.event.inputs.load_mode }}

      - name: Teardown
        if: always()
        env:
          TEMPORAL_IMAGE_TAG: ${{ github.event.inputs.temporal_version }}
        run: mise run teardown

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ§ª MongoDB Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine job outcome
          JOB_STATUS="${{ job.status }}"

          if [ "$JOB_STATUS" = "success" ]; then
            echo "### âœ… All validations passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Validation failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Configuration table
          echo "| Configuration | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ³ Image** | \`agdelen/temporal:${{ github.event.inputs.temporal_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸƒ MongoDB** | \`${{ github.event.inputs.mongodb_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ðŸ“… Date** | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Validation steps table
          echo "### ðŸ“‹ Validation Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

          # Tag validation
          TAG_RESULT="${{ steps.validate_tag.outcome }}"
          if [ "$TAG_RESULT" = "success" ]; then
            echo "| ðŸ” Image tag validation | âœ… Valid |" >> $GITHUB_STEP_SUMMARY
          elif [ "$TAG_RESULT" = "failure" ]; then
            echo "| ðŸ” Image tag validation | âŒ **Tag not found on Docker Hub** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ” Image tag validation | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          # Setup
          SETUP_RESULT="${{ steps.setup.outcome }}"
          if [ "$SETUP_RESULT" = "success" ]; then
            echo "| ðŸ—ï¸ Infrastructure setup | âœ… Ready |" >> $GITHUB_STEP_SUMMARY
          elif [ "$SETUP_RESULT" = "failure" ]; then
            echo "| ðŸ—ï¸ Infrastructure setup | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ—ï¸ Infrastructure setup | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          # E2E Tests
          E2E_RESULT="${{ steps.e2e.outcome }}"
          if [ "${{ github.event.inputs.run_e2e }}" != "true" ]; then
            echo "| ðŸ§ª E2E tests (329) | â­ï¸ Skipped (disabled) |" >> $GITHUB_STEP_SUMMARY
          elif [ "$E2E_RESULT" = "success" ]; then
            echo "| ðŸ§ª E2E tests (329) | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$E2E_RESULT" = "failure" ]; then
            echo "| ðŸ§ª E2E tests (329) | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§ª E2E tests (329) | â­ï¸ Skipped (prerequisite failed) |" >> $GITHUB_STEP_SUMMARY
          fi

          # Load Tests
          LOAD_RESULT="${{ steps.load.outcome }}"
          if [ "${{ github.event.inputs.run_load }}" != "true" ]; then
            echo "| ðŸ“Š Load tests (\`${{ github.event.inputs.load_mode }}\`) | â­ï¸ Skipped (disabled) |" >> $GITHUB_STEP_SUMMARY
          elif [ "$LOAD_RESULT" = "success" ]; then
            echo "| ðŸ“Š Load tests (\`${{ github.event.inputs.load_mode }}\`) | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$LOAD_RESULT" = "failure" ]; then
            echo "| ðŸ“Š Load tests (\`${{ github.event.inputs.load_mode }}\`) | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“Š Load tests (\`${{ github.event.inputs.load_mode }}\`) | â­ï¸ Skipped (prerequisite failed) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Load test details if available
          if [ -f "${{ env.LOAD_TEST_SUMMARY }}" ]; then
            cat "${{ env.LOAD_TEST_SUMMARY }}" >> $GITHUB_STEP_SUMMARY
          fi
